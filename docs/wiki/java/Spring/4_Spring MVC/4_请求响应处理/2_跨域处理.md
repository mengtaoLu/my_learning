# Spring MVC 跨域处理 (CORS)

## 1. CORS 简介
跨域资源共享 (CORS, Cross-Origin Resource Sharing) 是一种机制，它使用额外的 HTTP 头来告诉浏览器  让运行在一个 origin (domain) 上的 Web 应用被准许访问来自不同源服务器上的指定的资源。
当一个资源从与该资源本身所在的服务器不同的域、协议或端口请求一个资源时，资源会发起一个跨域 HTTP 请求。
出于安全原因，浏览器限制从脚本内发起的跨源 HTTP 请求。 例如，XMLHttpRequest 和 Fetch API 遵循同源策略。

## 2. Spring MVC 中的解决方案

### 2.1 局部配置 (`@CrossOrigin`)
在 Spring MVC 中，可以使用 `@CrossOrigin` 注解来启用跨域请求。该注解可以应用于类（Controller）或方法级别。

#### 方法级别
```java
@RestController
@RequestMapping("/account")
public class AccountController {

    @CrossOrigin
    @GetMapping("/{id}")
    public Account retrieve(@PathVariable Long id) {
        // ...
        return new Account();
    }

    @DeleteMapping("/{id}")
    public void remove(@PathVariable Long id) {
        // ...
    }
}
```
在上面的例子中，`retrieve` 方法允许任何域的跨域访问，而 `remove` 方法则不允许（除非另有配置）。

#### 类级别
```java
@CrossOrigin(origins = "http://domain2.com", maxAge = 3600)
@RestController
@RequestMapping("/account")
public class AccountController {

    @GetMapping("/{id}")
    public Account retrieve(@PathVariable Long id) {
        // ...
        return new Account();
    }

    @DeleteMapping("/{id}")
    public void remove(@PathVariable Long id) {
        // ...
    }
}
```
当应用在类级别时，它不仅作用于该类的所有处理方法，还会被继承。

### 2.2 全局配置 (`WebMvcConfigurer`)
除了细粒度的基于注解的配置，还可以定义全局 CORS 配置。这类似于使用过滤器，但可以在 Spring MVC 内部声明，并结合细粒度的 `@CrossOrigin` 配置。
默认情况下，全局配置允许所有来源、所有标头以及 `GET`, `HEAD`, `POST` 方法。

```java
@Configuration
@EnableWebMvc
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**") // 对哪些路径应用规则
                .allowedOrigins("https://domain2.com") // 允许的来源
                .allowedMethods("GET", "POST", "PUT", "DELETE") // 允许的方法
                .allowedHeaders("*") // 允许的头
                .allowCredentials(true) // 是否允许携带凭证
                .maxAge(3600); // 预检请求的有效期
    }
}
```

### 2.3 Filter 配置 (`CorsFilter`)
如果你使用 Spring Security 或者需要更底层的控制，可以使用 `CorsFilter`。
```java
@Bean
public CorsFilter corsFilter() {
    CorsConfiguration config = new CorsConfiguration();
    config.setAllowCredentials(true);
    config.addAllowedOrigin("http://domain1.com");
    config.addAllowedHeader("*");
    config.addAllowedMethod("*");

    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    source.registerCorsConfiguration("/**", config);
    
    return new CorsFilter(source);
}
```

## 3. Spring Security 中的跨域
如果项目中使用了 Spring Security，一定要在 Spring Security 的配置中也启用 CORS，否则请求可能会在到达 Spring MVC 之前就被拦截。

```java
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.cors().and() // 启用 CORS
            .csrf().disable()
            .authorizeRequests()
            .anyRequest().authenticated();
    }
    
    // 或者定义 CorsConfigurationSource Bean，Spring Security 会自动寻找名为 corsConfigurationSource 的 Bean
    @Bean
    CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("https://example.com"));
        configuration.setAllowedMethods(Arrays.asList("GET","POST"));
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```
注意：`CorsFilter` 需要定义在 Spring Security 过滤器链的前面，Spring Security 默认会处理这个顺序。

## 4.生效的原理

当控制器添加@CrossOrigin的时候，spring会拦截该请求，并在请求头中注入以下信息：

- Access-Control-Allow-Origin ：指定允许访问的域名，不写的话默认为*，表示允许所有域名访问
- Access-Control-Allow-Methods ：指定允许访问的方法，不写的话默认为*，表示允许所有方法访问
- Access-Control-Allow-Headers ：指定允许访问的头，不写的话默认为*，表示允许所有头访问
- Access-Control-Allow-Credentials ：指定是否允许携带凭证（Cookies、HTTP认证信息等），不写的话默认为false，表示不允许携带凭证。
    > **注意**：当 `Access-Control-Allow-Credentials` 为 `true` 时，`Access-Control-Allow-Origin` **不能** 设置为 `*`，必须是具体的域名，否则浏览器会报错。
- Access-Control-Max-Age ：指定预检请求的有效期，不写的话默认为3600，表示有效期为1小时
- Access-Control-Expose-Headers ：指定允许暴露的头，不写的话默认为*，表示允许暴露所有头
